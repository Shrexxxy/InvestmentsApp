@page "/Purchase"
@using InvestmentsApp.Client.Models
@using InvestmentsApp.Client.Models.PagedList
@using InvestmentsApp.Client.Models.Purchase
@using Microsoft.AspNetCore.WebUtilities

<PageTitle>История покупок</PageTitle>
<MudText 
    Typo="Typo.h5"
    Class="mt-5"
    Style="text-align: center;">
    История покупок
</MudText>

<MudStack 
    Justify="Justify.FlexEnd"
    Class="my-5" Row>
    <MudButton
        Href="/Purchase/Create"
        StartIcon="@Icons.Material.Outlined.Add">
        Добавить
    </MudButton>
</MudStack>


<MudDataGrid
    Dense
    SortMode="SortMode.None"
    @ref="_dataGrid"
    ServerData="FetchPurchases"
    T="PurchaseViewModel">
    <Columns>
        <PropertyColumn
            Class="w-25"
            Title="Id"
            Editable="false"
            Property="x => x.Id">
        </PropertyColumn>

        <PropertyColumn
            Title="Предмет"
            Property="x => x.ItemId">
            <CellTemplate>
                @($"{context.Item.ItemTypeName} {context.Item.ItemName} {context.Item.QualityName}")
            </CellTemplate>
        </PropertyColumn>
        
        <PropertyColumn
            Title="Количество"
            Property="x => x.Quantity">
        </PropertyColumn>
        
        <PropertyColumn
            Title="Цена за единицу"
            Property="x => x.PricePerUnit">
            <CellTemplate>
                @($"{context.Item.PricePerUnit} Руб.")
            </CellTemplate>
        </PropertyColumn>
        
        <PropertyColumn
            Title="Сумма"
            Property="x => x.TotalPrice">
            <CellTemplate>
                @($"{context.Item.TotalPrice} Руб.")
            </CellTemplate>
        </PropertyColumn>
        
        <PropertyColumn
            Title="Дата покупки"
            Property="x => x.PurchaseDate">
            <CellTemplate>
                @context.Item.PurchaseDate.ToShortDateString()
            </CellTemplate>
        </PropertyColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager></MudDataGridPager>
    </PagerContent>
</MudDataGrid>

@code {
    [Inject] private IHttpClientFactory HttpClientFactory { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private IDialogService DialogService { get; set; } = null!;

    private HttpClient _httpClient = null!;
    private MudDataGrid<PurchaseViewModel> _dataGrid = new();
    
    protected override async Task OnInitializedAsync()
    {
        _httpClient = HttpClientFactory.CreateClient("InvestmentBackendConfig");
        
        StateHasChanged();
    }
    
    private async Task<GridData<PurchaseViewModel>> FetchPurchases(GridState<PurchaseViewModel> state)
    {
        var queryParams = new Dictionary<string, string?>();
        
        queryParams.Add("pageIndex", state.Page.ToString());
        queryParams.Add("pageSize", state.PageSize.ToString());
        
        var url = QueryHelpers.AddQueryString("/api/purchase/paged", queryParams);
        
        var purchaseResponse = await _httpClient.GetAsync(url);

        if (!purchaseResponse.IsSuccessStatusCode)
        {
            Snackbar.Add("Ошибка Api");
            return new();
        }
        
        var purchases = await purchaseResponse.Content.ReadFromJsonAsync<PagedList<PurchaseViewModel>>();
        if (purchases is null)
        {
            Snackbar.Add("Ошибка при обработке данных");
            return new();
        }

        if (purchases.Subset is null || purchases.PageSize == 0)
        {
            Snackbar.Add("Нет данных");
            return new();
        }

        return new()
        {
            Items = purchases.Subset,
            TotalItems = purchases.PageCount
        };
    }
}